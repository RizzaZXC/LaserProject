<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>–ü–ª–∞–Ω –ø–æ–º–µ—â–µ–Ω–∏—è</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/konva@9.3.0/konva.min.js"></script>

<style>
  body {
    margin: 0;
    background: #f3f4f7;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .header {
    background: #fff;
    border-bottom: 1px solid #ddd;
    padding: 16px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 20;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  #plan-container {
    flex: 1;
    background: #fff;
    touch-action: none;
    position: relative;
  }

  .controls {
    background: #fff;
    border-top: 1px solid #ddd;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .button-row {
    display: flex;
    gap: 8px;
    width: 100%;
  }

  .button-row.single-button {
    justify-content: center;
    height: 44px;
  }

  .btn-control {
    height: 44px;
    font-size: 16px;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-height {
    padding: 0 20px;
    flex: none;
    width: 100%;
  }

  .empty-plan {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
    color: #666;
  }

  .empty-plan .icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .modal-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    border-radius: 12px 12px 0 0;
    padding: 16px 20px;
  }

  .modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
  }

  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
  }

  .form-control {
    border-radius: 8px;
    border: 1px solid #ced4da;
    padding: 10px 12px;
    font-size: 16px;
  }

  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  .object-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  .object-type-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .object-type-btn.active {
    border-color: #0d6efd;
    background: #e7f1ff;
  }

  .object-type-btn.window.active {
    border-color: #0dcaf0;
    background: #e8f7ff;
  }

  .object-type-btn.door.active {
    border-color: #20c997;
    background: #e8f8f3;
  }

  .objects-list {
    margin-top: 20px;
    border-top: 1px solid #eee;
    padding-top: 15px;
  }

  .objects-list h6 {
    margin-bottom: 10px;
    color: #555;
  }

  .object-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 8px;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease;
    touch-action: pan-y;
    user-select: none;
  }

  .object-item-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .object-icon {
    font-size: 20px;
  }

  .object-details {
    flex: 1;
  }

  .object-type {
    font-weight: 600;
    font-size: 14px;
  }

  .object-specs {
    font-size: 12px;
    color: #666;
  }

  .delete-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #dc3545;
    color: white;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 20px;
    font-weight: bold;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .object-item.deleting .delete-overlay {
    transform: translateX(0);
  }

  .empty-objects {
    text-align: center;
    padding: 20px;
    color: #999;
    font-style: italic;
  }

  .height-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .height-info h6 {
    margin-bottom: 10px;
    color: #333;
  }

  .height-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 14px;
  }

  .height-stat {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
  }

  .height-stat .label {
    color: #666;
  }

  .height-stat .value {
    font-weight: 600;
    color: #333;
  }

  .wall-mockup {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .mockup-container {
    position: relative;
    height: 200px;
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    border: 2px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
  }

  .wall-representation {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .object-mockup {
    position: absolute;
    border: 2px solid;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
    left: 50%;
    transform: translateX(-50%);
  }

  .window-mockup {
    background: rgba(13, 202, 240, 0.6);
    border-color: #0dcaf0;
  }

  .door-mockup {
    background: rgba(32, 201, 151, 0.6);
    border-color: #20c997;
  }

  .window-height-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .door-height-inputs {
    grid-template-columns: 1fr;
  }

  .window-height-inputs {
      display: flex;
      align-items: center;
      gap: 10px;
  }

  .form-control {
    margin-top: 0.5rem;
  }
</style>
</head>

<body>
<div class="header">
  <h1 class="h4 mb-0">–ü–ª–∞–Ω –ø–æ–º–µ—â–µ–Ω–∏—è</h1>
  <div style="font-size: 14px; color: #666; margin-top: 8px;">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Å—Ç–µ–Ω–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–∫–Ω–∞ –∏–ª–∏ –¥–≤–µ—Ä–∏</div>
</div>

<div id="plan-container">
  <div class="empty-plan">
    <div class="icon">üìê</div>
    <div style="font-size: 18px; margin-bottom: 8px;">–ü–ª–∞–Ω –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω</div>
    <div style="font-size: 14px;">–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç–µ–Ω—ã</div>
  </div>
</div>

<div class="controls">
  <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: 2 –∫–Ω–æ–ø–∫–∏ -->
  <div class="button-row">
    <button id="btnBack" class="btn btn-secondary btn-control">‚Üê –ù–∞–∑–∞–¥</button>
    <button id="btnResetView" class="btn btn-info btn-control">‚ü≤ –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥</button>
  </div>
  
  <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: 2 –∫–Ω–æ–ø–∫–∏ -->
  <div class="button-row">
    <button id="btnZoomIn" class="btn btn-primary btn-control">+</button>
    <button id="btnZoomOut" class="btn btn-primary btn-control">-</button>
  </div>
  
  <!-- –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞: 1 –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ -->
  <div class="button-row single-button">
    <button id="btnSettings" class="btn btn-success btn-height">‚öô –í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω</button>
  </div>
</div>

<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ -->
<div class="modal fade" id="objectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°—Ç–µ–Ω–∞ <span id="wallNumber"></span> - –û–±—ä–µ–∫—Ç—ã</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="object-type-selector">
          <div class="object-type-btn window active" data-type="window">
            <div style="font-size: 24px;">ü™ü</div>
            <div>–û–∫–Ω–æ</div>
          </div>
          <div class="object-type-btn door" data-type="door">
            <div style="font-size: 24px;">üö™</div>
            <div>–î–≤–µ—Ä—å</div>
          </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
        <div class="mb-3">
          <label class="form-label">–®–∏—Ä–∏–Ω–∞ –æ–±—ä–µ–∫—Ç–∞ (–º)</label>
          <input type="number" step="0.1" min="0.1" max="5" value="1.2" class="form-control" id="objectWidth">
        </div>
        
        <div class="mb-3">
          <label class="form-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª–∞ —Å—Ç–µ–Ω—ã (–º)</label>
          <input type="number" step="0.1" min="0" value="0.5" class="form-control" id="objectDistance">
        </div>

        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—Å–æ—Ç—ã –¥–ª—è –æ–∫–æ–Ω -->
        <div class="window-height-inputs">
          <div class="mb-3">
            <label class="form-label">–í—ã—Å–æ—Ç–∞ –æ—Ç –ø–æ–ª–∞ –¥–æ –æ–∫–Ω–∞ (–º)</label>
            <input type="number" step="0.1" min="0" max="5" value="0.9" class="form-control" id="windowBottomHeight">
          </div>
          <div class="mb-3">
            <label class="form-label">–í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ (–º)</label>
            <input type="number" step="0.1" min="0.1" max="5" value="1.2" class="form-control mt-4" id="windowHeight">
          </div>
        </div>
        
        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—Å–æ—Ç—ã –¥–ª—è –¥–≤–µ—Ä–µ–π -->
        <div class="door-height-inputs">
          <div class="mb-3">
            <label class="form-label">–í—ã—Å–æ—Ç–∞ –¥–≤–µ—Ä–∏ (–º)</label>
            <input type="number" step="0.1" min="0.1" max="5" value="2.0" class="form-control" id="doorHeight">
          </div>
        </div>
        
        <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –¥–ª—è –æ–∫–æ–Ω -->
        <div class="wall-mockup window-mockup-container">
          <label class="form-label">–ú–∞–∫–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ–∫–Ω–∞ –Ω–∞ —Å—Ç–µ–Ω–µ</label>
          <div class="mockup-container">
            <div class="wall-representation">
              <div class="object-mockup window-mockup" id="windowMockup">–û–ö–ù–û</div>
            </div>
          </div>
          <div class="form-text text-center" id="windowMockupInfo">
            –í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞: <span id="windowHeightValue">1.2</span> –º ‚Ä¢ –û—Ç –ø–æ–ª–∞: <span id="windowBottomValue">0.9</span> –º ‚Ä¢ –î–æ –ø–æ—Ç–æ–ª–∫–∞: <span id="windowTopValue">0.4</span> –º
          </div>
        </div>
        
        <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –¥–ª—è –¥–≤–µ—Ä–µ–π -->
        <div class="wall-mockup door-mockup-container" style="display: none;">
          <label class="form-label">–ú–∞–∫–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–≤–µ—Ä–∏ –Ω–∞ —Å—Ç–µ–Ω–µ</label>
          <div class="mockup-container">
            <div class="wall-representation">
              <div class="object-mockup door-mockup" id="doorMockup">–î–í–ï–†–¨</div>
            </div>
          </div>
          <div class="form-text text-center" id="doorMockupInfo">
            –í—ã—Å–æ—Ç–∞ –¥–≤–µ—Ä–∏: <span id="doorHeightValue">2.0</span> –º ‚Ä¢ –î–æ –ø–æ—Ç–æ–ª–∫–∞: <span id="doorTopValue">0.5</span> –º
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">–î–ª–∏–Ω–∞ —Å—Ç–µ–Ω—ã: <span id="wallLengthValue">0</span> –º</label>
          <div class="progress mt-2">
            <div id="placementIndicator" class="progress-bar" style="width: 0%"></div>
          </div>
          <div class="form-text" id="placementInfo"></div>
        </div>

        <button type="button" class="btn btn-primary w-100" id="btnConfirmObject">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å—Ç–µ–Ω–µ -->
        <div class="objects-list">
          <h6>–û–±—ä–µ–∫—Ç—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç–µ–Ω–µ:</h6>
          <div id="objectsListContainer">
            <div class="empty-objects">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç—ã —Å—Ç–µ–Ω -->
<div class="modal fade" id="heightModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ—Ç—ã —Å—Ç–µ–Ω</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω (–º)</label>
          <input type="number" step="0.1" min="0.1" max="10" value="2.5" class="form-control" id="wallHeight">
          <div class="form-text">–û–±—â–∞—è –≤—ã—Å–æ—Ç–∞ –≤—Å–µ—Ö —Å—Ç–µ–Ω –ø–æ–º–µ—â–µ–Ω–∏—è</div>
        </div>

        <div class="height-info">
          <h6>–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</h6>
          <div class="height-stats">
            <div class="height-stat">
              <span class="label">–í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω:</span>
              <span class="value" id="currentWallHeight">2.5 –º</span>
            </div>
            <div class="height-stat">
              <span class="label">–û–∫–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω–æ:</span>
              <span class="value" id="windowsCount">0 —à—Ç</span>
            </div>
            <div class="height-stat">
              <span class="label">–î–≤–µ—Ä–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–æ:</span>
              <span class="value" id="doorsCount">0 —à—Ç</span>
            </div>
            <div class="height-stat">
              <span class="label">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å —Å—Ç–µ–Ω:</span>
              <span class="value" id="totalWallArea">0 –º¬≤</span>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-primary w-100" id="btnSaveHeights">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const PIXELS_PER_METER = 50;
let stage, layer;
let walls = [];
let windows = [];
let doors = [];
let scale = 1;
let selectedWallIndex = null;
let currentObjectType = 'window';
let objectModal = null;
let heightModal = null;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç
let roomSettings = {
  wallHeight: 2.5
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
function loadData() {
  const savedWalls = localStorage.getItem('roomWalls');
  const savedWindows = localStorage.getItem('roomWindows');
  const savedDoors = localStorage.getItem('roomDoors');
  const savedSettings = localStorage.getItem('roomSettings');
  
  if (savedWalls) {
    walls = JSON.parse(savedWalls);
  }
  if (savedWindows) {
    windows = JSON.parse(savedWindows);
  }
  if (savedDoors) {
    doors = JSON.parse(savedDoors);
  }
  if (savedSettings) {
    roomSettings = JSON.parse(savedSettings);
  }
  
  if (walls.length > 0) {
    drawPlan();
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
function saveData() {
  localStorage.setItem('roomWalls', JSON.stringify(walls));
  localStorage.setItem('roomWindows', JSON.stringify(windows));
  localStorage.setItem('roomDoors', JSON.stringify(doors));
  localStorage.setItem('roomSettings', JSON.stringify(roomSettings));
}

// –†–∞—Å—á–µ—Ç –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏ —Å—Ç–µ–Ω
function calculateWallArea() {
  let totalLength = 0;
  walls.forEach(wall => {
    totalLength += wall.length;
  });
  return (totalLength * roomSettings.wallHeight).toFixed(1);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –≤—ã—Å–æ—Ç
function updateHeightStats() {
  document.getElementById('currentWallHeight').textContent = roomSettings.wallHeight + ' –º';
  document.getElementById('windowsCount').textContent = windows.length + ' —à—Ç';
  document.getElementById('doorsCount').textContent = doors.length + ' —à—Ç';
  document.getElementById('totalWallArea').textContent = calculateWallArea() + ' –º¬≤';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫–µ—Ç–∞ –¥–ª—è –æ–∫–æ–Ω
function updateWindowMockup() {
  const windowHeight = parseFloat(document.getElementById('windowHeight').value) || 0;
  const bottomHeight = parseFloat(document.getElementById('windowBottomHeight').value) || 0;
  const wallHeight = roomSettings.wallHeight;
  const wallLength = walls[selectedWallIndex].length;
  const objectWidth = parseFloat(document.getElementById('objectWidth').value) || 0;
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –æ–∫–Ω–∞ –¥–æ –ø–æ—Ç–æ–ª–∫–∞
  const topHeight = wallHeight - bottomHeight - windowHeight;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  document.getElementById('windowHeightValue').textContent = windowHeight.toFixed(1);
  document.getElementById('windowBottomValue').textContent = bottomHeight.toFixed(1);
  document.getElementById('windowTopValue').textContent = topHeight.toFixed(1);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫–µ—Ç
  const windowMockup = document.getElementById('windowMockup');
  const containerWidth = 300; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  const containerHeight = 200; // –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ - –æ–±—ä–µ–∫—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É
  const widthPercent = (objectWidth / wallLength) * 100;
  
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ
  const bottomPercent = (bottomHeight / wallHeight) * 100;
  const heightPercent = (windowHeight / wallHeight) * 100;
  
  // –û–±—ä–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
  windowMockup.style.width = widthPercent + '%';
  windowMockup.style.bottom = bottomPercent + '%';
  windowMockup.style.height = heightPercent + '%';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –æ–∫–Ω–æ
  const fits = windowHeight > 0 && topHeight >= 0;
  const infoElement = document.getElementById('windowMockupInfo');
  
  if (fits) {
    infoElement.className = 'form-text text-center text-success';
  } else {
    infoElement.className = 'form-text text-center text-danger';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫–µ—Ç–∞ –¥–ª—è –¥–≤–µ—Ä–µ–π
function updateDoorMockup() {
  const doorHeight = parseFloat(document.getElementById('doorHeight').value) || 0;
  const wallHeight = roomSettings.wallHeight;
  const wallLength = walls[selectedWallIndex].length;
  const objectWidth = parseFloat(document.getElementById('objectWidth').value) || 0;
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –¥–≤–µ—Ä–∏ –¥–æ –ø–æ—Ç–æ–ª–∫–∞
  const topHeight = wallHeight - doorHeight;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  document.getElementById('doorHeightValue').textContent = doorHeight.toFixed(1);
  document.getElementById('doorTopValue').textContent = topHeight.toFixed(1);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫–µ—Ç
  const doorMockup = document.getElementById('doorMockup');
  
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ - –æ–±—ä–µ–∫—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É
  const widthPercent = (objectWidth / wallLength) * 100;
  
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ
  const heightPercent = (doorHeight / wallHeight) * 100;
  
  // –û–±—ä–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
  doorMockup.style.width = widthPercent + '%';
  doorMockup.style.bottom = '0%';
  doorMockup.style.height = heightPercent + '%';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –¥–≤–µ—Ä—å
  const fits = doorHeight > 0 && topHeight >= 0;
  const infoElement = document.getElementById('doorMockupInfo');
  
  if (fits) {
    infoElement.className = 'form-text text-center text-success';
  } else {
    infoElement.className = 'form-text text-center text-danger';
  }
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–º–µ—â–µ–Ω–∏—è
function drawPlan() {
  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  const container = document.getElementById('plan-container');
  container.innerHTML = '';
  
  // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É
  stage = new Konva.Stage({
    container: 'plan-container',
    width: container.clientWidth,
    height: container.clientHeight,
    listening: true
  });

  layer = new Konva.Layer({
    listening: true
  });
  stage.add(layer);

  // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (—Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞)
  let currentX = stage.width() / 2;
  let currentY = stage.height() / 2;
  let currentAngle = 0;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  const wallPositions = [];

  // –†–∏—Å—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É
  const startPoint = new Konva.Circle({
    x: currentX,
    y: currentY,
    radius: 8,
    fill: '#28a745',
    stroke: '#fff',
    strokeWidth: 2,
    listening: false
  });
  layer.add(startPoint);

  // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—ã
  walls.forEach((wall, index) => {
    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É —Å—Ç–µ–Ω—ã
    const angleRad = (currentAngle + wall.angle) * Math.PI / 180;
    const endX = currentX + Math.cos(angleRad) * wall.length * PIXELS_PER_METER;
    const endY = currentY + Math.sin(angleRad) * wall.length * PIXELS_PER_METER;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–µ–Ω—ã
    wallPositions.push({
      startX: currentX,
      startY: currentY,
      endX: endX,
      endY: endY,
      angle: currentAngle + wall.angle,
      length: wall.length
    });

    // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—É—é –ª–∏–Ω–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–æ–≤
    const hitLine = new Konva.Line({
      points: [currentX, currentY, endX, endY],
      stroke: 'rgba(0,0,0,0.01)',
      strokeWidth: 40,
      lineCap: 'round',
      lineJoin: 'round',
      name: `wall-hit-${index}`,
      listening: true
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–µ–Ω—ã
    let lastClickTime = 0;
    hitLine.on('click tap', (e) => {
      const currentTime = new Date().getTime();
      const timeDiff = currentTime - lastClickTime;
      
      if (timeDiff < 500 && timeDiff > 0) {
        selectedWallIndex = index;
        openObjectModal(index);
        lastClickTime = 0;
      } else {
        lastClickTime = currentTime;
      }
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
      e.cancelBubble = true;
    });

    // –†–∏—Å—É–µ–º –≤–∏–¥–∏–º—É—é –ª–∏–Ω–∏—é —Å—Ç–µ–Ω—ã
    const line = new Konva.Line({
      points: [currentX, currentY, endX, endY],
      stroke: '#333',
      strokeWidth: 8,
      lineCap: 'round',
      lineJoin: 'round',
      name: `wall-${index}`,
      listening: false
    });

    // –†–∏—Å—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É —Å—Ç–µ–Ω—ã (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π)
    if (index > 0) {
      const joint = new Konva.Circle({
        x: currentX,
        y: currentY,
        radius: 5,
        fill: '#0d6efd',
        listening: false
      });
      layer.add(joint);
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —Å–µ—Ä–µ–¥–∏–Ω—É —Å—Ç–µ–Ω—ã –¥–ª—è –Ω–æ–º–µ—Ä–∞
    const midX = (currentX + endX) / 2;
    const midY = (currentY + endY) / 2;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞
    const wallAngle = Math.atan2(endY - currentY, endX - currentX);
    const offsetDistance = 25;
    const offsetX = Math.cos(wallAngle + Math.PI/2) * offsetDistance;
    const offsetY = Math.sin(wallAngle + Math.PI/2) * offsetDistance;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç–µ–Ω—ã —Å–±–æ–∫—É –æ—Ç —Å—Ç–µ–Ω—ã
    const textBackground = new Konva.Rect({
      x: midX + offsetX - 15,
      y: midY + offsetY - 10,
      width: 30,
      height: 20,
      fill: 'rgba(255, 255, 255, 0.9)',
      stroke: '#ddd',
      strokeWidth: 1,
      cornerRadius: 4,
      listening: false
    });

    const text = new Konva.Text({
      x: midX + offsetX - 10,
      y: midY + offsetY - 8,
      text: (index + 1).toString(),
      fontSize: 14,
      fontFamily: 'Arial',
      fill: '#333',
      fontWeight: 'bold',
      listening: false
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–ª–æ–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    layer.add(hitLine); // –°–Ω–∞—á–∞–ª–∞ hitLine –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
    layer.add(line);
    layer.add(textBackground);
    layer.add(text);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∏ —É–≥–æ–ª
    currentX = endX;
    currentY = endY;
    currentAngle += wall.angle;
  });

  // –†–∏—Å—É–µ–º –æ–∫–Ω–∞
  windows.forEach((window, index) => {
    const wallPos = wallPositions[window.wallIndex];
    if (!wallPos) return;

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ–∫–Ω–∞ –Ω–∞ —Å—Ç–µ–Ω–µ
    const angleRad = wallPos.angle * Math.PI / 180;
    const windowStartX = wallPos.startX + Math.cos(angleRad) * window.distance * PIXELS_PER_METER;
    const windowStartY = wallPos.startY + Math.sin(angleRad) * window.distance * PIXELS_PER_METER;
    const windowEndX = windowStartX + Math.cos(angleRad) * window.width * PIXELS_PER_METER;
    const windowEndY = windowStartY + Math.sin(angleRad) * window.width * PIXELS_PER_METER;

    // –†–∏—Å—É–µ–º –æ–∫–Ω–æ (—Å–∏–Ω—è—è –ª–∏–Ω–∏—è)
    const windowLine = new Konva.Line({
      points: [windowStartX, windowStartY, windowEndX, windowEndY],
      stroke: '#0dcaf0',
      strokeWidth: 12,
      lineCap: 'round',
      listening: false
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ª–æ–∂–∫—É –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    const windowBackground = new Konva.Line({
      points: [windowStartX, windowStartY, windowEndX, windowEndY],
      stroke: 'white',
      strokeWidth: 14,
      lineCap: 'round',
      listening: false
    });

    layer.add(windowBackground);
    layer.add(windowLine);
  });

  // –†–∏—Å—É–µ–º –¥–≤–µ—Ä–∏
  doors.forEach((door, index) => {
    const wallPos = wallPositions[door.wallIndex];
    if (!wallPos) return;

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–≤–µ—Ä–∏ –Ω–∞ —Å—Ç–µ–Ω–µ
    const angleRad = wallPos.angle * Math.PI / 180;
    const doorStartX = wallPos.startX + Math.cos(angleRad) * door.distance * PIXELS_PER_METER;
    const doorStartY = wallPos.startY + Math.sin(angleRad) * door.distance * PIXELS_PER_METER;
    const doorEndX = doorStartX + Math.cos(angleRad) * door.width * PIXELS_PER_METER;
    const doorEndY = doorStartY + Math.sin(angleRad) * door.width * PIXELS_PER_METER;

    // –†–∏—Å—É–µ–º –¥–≤–µ—Ä—å (–∑–µ–ª–µ–Ω–∞—è –ª–∏–Ω–∏—è —Å —Ä–∞–∑—Ä—ã–≤–æ–º)
    const doorLine = new Konva.Line({
      points: [doorStartX, doorStartY, doorEndX, doorEndY],
      stroke: '#20c997',
      strokeWidth: 8,
      lineCap: 'round',
      dash: [10, 5],
      listening: false
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ª–æ–∂–∫—É –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    const doorBackground = new Konva.Line({
      points: [doorStartX, doorStartY, doorEndX, doorEndY],
      stroke: 'white',
      strokeWidth: 10,
      lineCap: 'round',
      listening: false
    });

    // –†–∏—Å—É–µ–º –¥—É–≥—É –æ—Ç–∫—Ä—ã–≤–∞–Ω–∏—è –¥–≤–µ—Ä–∏
    const arcRadius = door.width * PIXELS_PER_METER;
    const doorArc = new Konva.Arc({
      x: doorStartX,
      y: doorStartY,
      innerRadius: 0,
      outerRadius: arcRadius,
      angle: 90,
      rotation: wallPos.angle,
      stroke: '#20c997',
      strokeWidth: 2,
      opacity: 0.7,
      listening: false
    });

    layer.add(doorBackground);
    layer.add(doorLine);
    layer.add(doorArc);
  });

  // –†–∏—Å—É–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
  const endPoint = new Konva.Circle({
    x: currentX,
    y: currentY,
    radius: 8,
    fill: '#dc3545',
    stroke: '#fff',
    strokeWidth: 2,
    listening: false
  });
  layer.add(endPoint);

  // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
  const legend = new Konva.Group({
    x: 20,
    y: 20,
    listening: false
  });

  const legendBackground = new Konva.Rect({
    width: 180,
    height: 120,
    fill: 'white',
    stroke: '#ddd',
    strokeWidth: 1,
    cornerRadius: 8,
    listening: false
  });

  const startLegend = new Konva.Circle({
    x: 20,
    y: 25,
    radius: 6,
    fill: '#28a745',
    listening: false
  });

  const startText = new Konva.Text({
    x: 35,
    y: 20,
    text: '–ù–∞—á–∞–ª–æ',
    fontSize: 14,
    fontFamily: 'Arial',
    fill: '#333',
    listening: false
  });

  const endLegend = new Konva.Circle({
    x: 20,
    y: 50,
    radius: 6,
    fill: '#dc3545',
    listening: false
  });

  const endText = new Konva.Text({
    x: 35,
    y: 45,
    text: '–ö–æ–Ω–µ—Ü',
    fontSize: 14,
    fontFamily: 'Arial',
    fill: '#333',
    listening: false
  });

  const windowLegend = new Konva.Line({
    points: [15, 75, 25, 75],
    stroke: '#0dcaf0',
    strokeWidth: 8,
    lineCap: 'round',
    listening: false
  });

  const windowText = new Konva.Text({
    x: 35,
    y: 70,
    text: '–û–∫–Ω–æ',
    fontSize: 14,
    fontFamily: 'Arial',
    fill: '#333',
    listening: false
  });

  const doorLegend = new Konva.Line({
    points: [15, 100, 25, 100],
    stroke: '#20c997',
    strokeWidth: 8,
    lineCap: 'round',
    dash: [10, 5],
    listening: false
  });

  const doorText = new Konva.Text({
    x: 35,
    y: 95,
    text: '–î–≤–µ—Ä—å',
    fontSize: 14,
    fontFamily: 'Arial',
    fill: '#333',
    listening: false
  });

  legend.add(legendBackground);
  legend.add(startLegend);
  legend.add(startText);
  legend.add(endLegend);
  legend.add(endText);
  legend.add(windowLegend);
  legend.add(windowText);
  legend.add(doorLegend);
  legend.add(doorText);
  layer.add(legend);

  layer.batchDraw();

  // –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
  stage.draggable(true);
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
function openObjectModal(wallIndex) {
  const wall = walls[wallIndex];
  if (!wall) {
    console.error('–°—Ç–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', wallIndex);
    return;
  }
  
  selectedWallIndex = wallIndex;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  document.getElementById('wallNumber').textContent = wallIndex + 1;
  document.getElementById('wallLengthValue').textContent = wall.length.toFixed(1);
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
  const widthInput = document.getElementById('objectWidth');
  
  if (currentObjectType === 'window') {
    widthInput.value = '1.2';
    widthInput.min = '0.5';
    widthInput.max = '3';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –æ–∫–æ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –¥–≤–µ—Ä–µ–π
    document.querySelector('.window-height-inputs').style.display = 'grid';
    document.querySelector('.door-height-inputs').style.display = 'none';
    document.querySelector('.window-mockup-container').style.display = 'block';
    document.querySelector('.door-mockup-container').style.display = 'none';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–∫–æ–Ω
    document.getElementById('windowBottomHeight').value = '0.9';
    document.getElementById('windowHeight').value = '1.2';
    
    updateWindowMockup();
  } else {
    widthInput.value = '0.9';
    widthInput.min = '0.6';
    widthInput.max = '1.2';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –¥–≤–µ—Ä–µ–π, —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –æ–∫–æ–Ω
    document.querySelector('.window-height-inputs').style.display = 'none';
    document.querySelector('.door-height-inputs').style.display = 'block';
    document.querySelector('.window-mockup-container').style.display = 'none';
    document.querySelector('.door-mockup-container').style.display = 'block';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –¥–≤–µ—Ä–µ–π
    document.getElementById('doorHeight').value = '2.0';
    
    updateDoorMockup();
  }
  
  document.getElementById('objectDistance').value = '0.5';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  updatePlacementIndicator();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤
  updateObjectsList();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  if (!objectModal) {
    objectModal = new bootstrap.Modal(document.getElementById('objectModal'));
  }
  objectModal.show();
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç
function openHeightModal() {
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  document.getElementById('wallHeight').value = roomSettings.wallHeight;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  updateHeightStats();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  if (!heightModal) {
    heightModal = new bootstrap.Modal(document.getElementById('heightModal'));
  }
  heightModal.show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—ã—Å–æ—Ç
function saveHeightSettings() {
  const wallHeight = parseFloat(document.getElementById('wallHeight').value);
  
  if (wallHeight) {
    roomSettings.wallHeight = wallHeight;
    
    saveData();
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–ª–∞–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã—Å–æ—Ç–∞—Ö
    if (walls.length > 0) {
      drawPlan();
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('heightModal'));
    modal.hide();
    
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
  } else {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤—ã—Å–æ—Ç—É —Å—Ç–µ–Ω.');
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å—Ç–µ–Ω–µ
function updateObjectsList() {
  const container = document.getElementById('objectsListContainer');
  const wallObjects = [];
  
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–µ–Ω–µ
  windows.forEach((window, index) => {
    if (window.wallIndex === selectedWallIndex) {
      wallObjects.push({
        type: 'window',
        width: window.width,
        height: window.height,
        bottomHeight: window.bottomHeight,
        distance: window.distance,
        index: index
      });
    }
  });
  
  doors.forEach((door, index) => {
    if (door.wallIndex === selectedWallIndex) {
      wallObjects.push({
        type: 'door',
        width: door.width,
        height: door.height,
        distance: door.distance,
        index: index
      });
    }
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –æ—Ç –Ω–∞—á–∞–ª–∞ —Å—Ç–µ–Ω—ã
  wallObjects.sort((a, b) => a.distance - b.distance);
  
  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  container.innerHTML = '';
  
  if (wallObjects.length === 0) {
    container.innerHTML = '<div class="empty-objects">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</div>';
    return;
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ —Å–ø–∏—Å–æ–∫
  wallObjects.forEach(obj => {
    const objectItem = document.createElement('div');
    objectItem.className = 'object-item';
    objectItem.setAttribute('data-type', obj.type);
    objectItem.setAttribute('data-index', obj.index);
    
    if (obj.type === 'window') {
      const topHeight = roomSettings.wallHeight - obj.bottomHeight - obj.height;
      objectItem.innerHTML = `
        <div class="object-item-content">
          <div class="object-icon">ü™ü</div>
          <div class="object-details">
            <div class="object-type">–û–∫–Ω–æ</div>
            <div class="object-specs">–®: ${obj.width.toFixed(1)}–º √ó –í: ${obj.height.toFixed(1)}–º ‚Ä¢ –û—Ç –ø–æ–ª–∞: ${obj.bottomHeight.toFixed(1)}–º ‚Ä¢ –î–æ –ø–æ—Ç–æ–ª–∫–∞: ${topHeight.toFixed(1)}–º ‚Ä¢ –û—Ç –Ω–∞—á–∞–ª–∞: ${obj.distance.toFixed(1)}–º</div>
          </div>
        </div>
        <div class="delete-overlay">–£–¥–∞–ª–∏—Ç—å</div>
      `;
    } else {
      const topHeight = roomSettings.wallHeight - obj.height;
      objectItem.innerHTML = `
        <div class="object-item-content">
          <div class="object-icon">üö™</div>
          <div class="object-details">
            <div class="object-type">–î–≤–µ—Ä—å</div>
            <div class="object-specs">–®: ${obj.width.toFixed(1)}–º √ó –í: ${obj.height.toFixed(1)}–º ‚Ä¢ –î–æ –ø–æ—Ç–æ–ª–∫–∞: ${topHeight.toFixed(1)}–º ‚Ä¢ –û—Ç –Ω–∞—á–∞–ª–∞: ${obj.distance.toFixed(1)}–º</div>
          </div>
        </div>
        <div class="delete-overlay">–£–¥–∞–ª–∏—Ç—å</div>
      `;
    }
    
    container.appendChild(objectItem);
  });
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–∞
  setupSwipeHandlers();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–≤–∞–π–ø–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤
function setupSwipeHandlers() {
  const items = document.querySelectorAll('.object-item');
  
  items.forEach(item => {
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;
    
    item.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      isSwiping = true;
      e.preventDefault();
    }, { passive: false });
    
    item.addEventListener('touchmove', (e) => {
      if (!isSwiping) return;
      
      currentX = e.touches[0].clientX;
      const diff = startX - currentX;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
      if (diff > 0 && diff <= 120) {
        item.style.transform = `translateX(-${diff}px)`;
        e.preventDefault();
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º —Å–º–µ—â–µ–Ω–∏–∏
      if (diff > 60) {
        item.classList.add('deleting');
      } else {
        item.classList.remove('deleting');
      }
    }, { passive: false });
    
    item.addEventListener('touchend', () => {
      if (!isSwiping) return;
      
      const diff = startX - currentX;
      
      // –ï—Å–ª–∏ —Å–≤–∞–π–ø–Ω—É–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–ª–µ–∫–æ - —É–¥–∞–ª—è–µ–º
      if (diff > 80) {
        const type = item.getAttribute('data-type');
        const index = parseInt(item.getAttribute('data-index'));
        removeObject(type, index);
      } else {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
        item.style.transform = 'translateX(0)';
        item.classList.remove('deleting');
      }
      
      isSwiping = false;
    });
  });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
function removeObject(type, index) {
  if (type === 'window') {
    windows.splice(index, 1);
  } else {
    doors.splice(index, 1);
  }
  
  saveData();
  drawPlan();
  updateObjectsList();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
function updatePlacementIndicator() {
  const width = parseFloat(document.getElementById('objectWidth').value) || 0;
  const distance = parseFloat(document.getElementById('objectDistance').value) || 0;
  const wallLength = walls[selectedWallIndex].length;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –Ω–∞ —Å—Ç–µ–Ω—É
  const total = distance + width;
  const fits = total <= wallLength;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  const placementPercent = Math.min((total / wallLength) * 100, 100);
  const indicator = document.getElementById('placementIndicator');
  indicator.style.width = placementPercent + '%';
  indicator.className = 'progress-bar ' + (fits ? 'bg-success' : 'bg-danger');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏
  const info = document.getElementById('placementInfo');
  if (fits) {
    info.textContent = `–û–±—ä–µ–∫—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–µ–Ω—É. –û—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç–∞: ${(wallLength - total).toFixed(1)} –º`;
    info.className = 'form-text text-success';
  } else {
    info.textContent = `–û–±—ä–µ–∫—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è! –í—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å—Ç–µ–Ω—ã –Ω–∞ ${(total - wallLength).toFixed(1)} –º`;
    info.className = 'form-text text-danger';
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (–æ–∫–Ω–∞ –∏–ª–∏ –¥–≤–µ—Ä–∏)
function addObject() {
  const width = parseFloat(document.getElementById('objectWidth').value);
  const distance = parseFloat(document.getElementById('objectDistance').value);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–µ–Ω—É
  const wall = walls[selectedWallIndex];
  if (distance + width > wall.length) {
    alert('–û–±—ä–µ–∫—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç–µ–Ω—É! –£–º–µ–Ω—å—à–∏—Ç–µ —à–∏—Ä–∏–Ω—É –∏–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ.');
    return;
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∞—Å—Å–∏–≤
  if (currentObjectType === 'window') {
    const height = parseFloat(document.getElementById('windowHeight').value);
    const bottomHeight = parseFloat(document.getElementById('windowBottomHeight').value);
    const topHeight = roomSettings.wallHeight - bottomHeight - height;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–∫–Ω–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
    if (height <= 0 || topHeight < 0) {
      alert('–û–∫–Ω–æ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ! –£–º–µ–Ω—å—à–∏—Ç–µ –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –∏–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ø–æ–ª–∞.');
      return;
    }
    
    windows.push({
      wallIndex: selectedWallIndex,
      width: width,
      height: height,
      bottomHeight: bottomHeight,
      distance: distance
    });
  } else {
    const height = parseFloat(document.getElementById('doorHeight').value);
    const topHeight = roomSettings.wallHeight - height;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–≤–µ—Ä—å –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
    if (height <= 0 || topHeight < 0) {
      alert('–î–≤–µ—Ä—å –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ! –£–º–µ–Ω—å—à–∏—Ç–µ –≤—ã—Å–æ—Ç—É –¥–≤–µ—Ä–∏.');
      return;
    }
    
    doors.push({
      wallIndex: selectedWallIndex,
      width: width,
      height: height,
      distance: distance
    });
  }
  
  saveData();
  drawPlan();
  updateObjectsList();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  if (currentObjectType === 'window') {
    document.getElementById('objectWidth').value = '1.2';
    document.getElementById('windowBottomHeight').value = '0.9';
    document.getElementById('windowHeight').value = '1.2';
    updateWindowMockup();
  } else {
    document.getElementById('objectWidth').value = '0.9';
    document.getElementById('doorHeight').value = '2.0';
    updateDoorMockup();
  }
  document.getElementById('objectDistance').value = '0.5';
  updatePlacementIndicator();
}

// –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
function zoom(factor) {
  scale *= factor;
  stage.scale({ x: scale, y: scale });
  stage.batchDraw();
}

// –°–±—Ä–æ—Å –≤–∏–¥–∞
function resetView() {
  scale = 1;
  stage.scale({ x: 1, y: 1 });
  stage.position({ x: 0, y: 0 });
  stage.batchDraw();
}

// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
function handleResize() {
  if (stage && walls.length > 0) {
    const container = document.getElementById('plan-container');
    stage.width(container.clientWidth);
    stage.height(container.clientHeight);
    stage.batchDraw();
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç—Ä–æ–∏–º –ø–ª–∞–Ω
  loadData();
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
  document.querySelectorAll('.object-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.object-type-btn').forEach(b => {
        b.classList.remove('active');
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
      this.classList.add('active');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
      currentObjectType = this.getAttribute('data-type');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
      const widthInput = document.getElementById('objectWidth');
      if (currentObjectType === 'window') {
        widthInput.value = '1.2';
        widthInput.min = '0.5';
        widthInput.max = '3';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –æ–∫–æ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –¥–≤–µ—Ä–µ–π
        document.querySelector('.window-height-inputs').style.display = 'grid';
        document.querySelector('.door-height-inputs').style.display = 'none';
        document.querySelector('.window-mockup-container').style.display = 'block';
        document.querySelector('.door-mockup-container').style.display = 'none';
        
        updateWindowMockup();
      } else {
        widthInput.value = '0.9';
        widthInput.min = '0.6';
        widthInput.max = '1.2';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –¥–≤–µ—Ä–µ–π, —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –æ–∫–æ–Ω
        document.querySelector('.window-height-inputs').style.display = 'none';
        document.querySelector('.door-height-inputs').style.display = 'block';
        document.querySelector('.window-mockup-container').style.display = 'none';
        document.querySelector('.door-mockup-container').style.display = 'block';
        
        updateDoorMockup();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      updatePlacementIndicator();
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–µ
  document.getElementById('objectWidth').addEventListener('input', updatePlacementIndicator);
  document.getElementById('objectDistance').addEventListener('input', updatePlacementIndicator);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç
  document.getElementById('windowBottomHeight').addEventListener('input', updateWindowMockup);
  document.getElementById('windowHeight').addEventListener('input', updateWindowMockup);
  document.getElementById('doorHeight').addEventListener('input', updateDoorMockup);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
  document.getElementById('btnConfirmObject').addEventListener('click', addObject);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—ã—Å–æ—Ç
  document.getElementById('btnSaveHeights').addEventListener('click', saveHeightSettings);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  document.getElementById('btnBack').addEventListener('click', () => {
    window.location.href = 'laser.html';
  });
  
  document.getElementById('btnZoomIn').addEventListener('click', () => {
    if (stage) zoom(1.2);
  });
  
  document.getElementById('btnZoomOut').addEventListener('click', () => {
    if (stage) zoom(0.8);
  });
  
  document.getElementById('btnResetView').addEventListener('click', () => {
    if (stage) resetView();
  });
  
  document.getElementById('btnSettings').addEventListener('click', openHeightModal);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', handleResize);
});
</script>
</body>
</html>